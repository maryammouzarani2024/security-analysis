#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <unistd.h>
#include <ctype.h>

#define WRONG_FORMAT_RET {\
	printf("wrong input format\n");\
	return -1;}

int fread_string(int fd, char* s , int len)
{
	char ch = 0;
	int index = 0;
	read(fd, (char*)&ch, 1);
	if (ch != '\'')
		return 1;
	while ((index < len || len == -1) && read(fd, (char*)&ch, 1))
	{
		if (ch == '\'')
		{
			read(fd, (char*)&ch,1);
			break;
		}
		s[index++] = ch;
	}
	return 0;
//		printf("%d %d %d %d %s\n",index,len, ch, isspace(ch), s);	
}

int main(int argc, char *argv[]) {
	char header[10] = { 0, };
	char buffer[256] = { 0, };
	char username[34] = { 0, };
	char *addr = (char*) malloc(128);
	char ncode [12]={0,};
	char ip[16] = { 0, };

	if (argc != 2) {
		printf("Usage: %s <file>\n", argv[0]);
		exit(-1);
	}

	int fd = open(argv[1], O_RDONLY);
	//FILE *fp = fopen(argv[1], "rt");
	if (fd == NULL)
	{
		printf("Wrong file name\n");
		exit(-1);
	}
/*	char c = ' ';
	printf("\n\t\t%d",c);
	c = '\n';
	printf("\n\t\t%d",c);
	c = '\r';
	printf("\n\t\t%d",c);
	return 0;
*/
	read(fd , header , 6);
	if (strcmp(header, "<User ") == 0)
	{
		memset(header , 0 , 10);		
		read(fd, header, 5);		
		if (strcmp(header, "name=") != 0)
			WRONG_FORMAT_RET;
		fread_string(fd, username, 32);
	
		memset(header , 0 , 10);
		read(fd, header , 3);
		if (strcmp(header, "ip=") != 0)
			WRONG_FORMAT_RET;
		fread_string(fd, ip, 15);

		if (strcmp(ip, "192.168.0.1") ==0)
		{		
			memset(header , 0 , 10);
			read(fd, header , 5);
			if (strcmp(header, "addr=") != 0)
				WRONG_FORMAT_RET;
			fread_string(fd, addr, -1);
		}

		memset(header , 0 , 10);
		read(fd, header , 6);
		if (strcmp(header, "NCode=") != 0)
			WRONG_FORMAT_RET;
		fread_string(fd, ncode, -1);
		
	}
	else
		WRONG_FORMAT_RET;
	
	printf("\tUser[%s] read with ip=%s , addr=%s and ncode=%s\n", username,ip, addr, ncode);

	return 0;
}
